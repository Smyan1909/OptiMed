flowchart TD
    %% ─────────── Front-end ───────────
    subgraph Browser["Doctor / Nurse workstation"]
        NJS[Next.js UI<br>• KPI Dashboard<br>• Chat pane<br>• SMART-on-FHIR launcher]
    end

    %% ─────────── API & Orchestrator ───────────
    subgraph Backend["Python services (Docker / K8s namespace)"]
        GW[FastAPI<br>api_gateway] -->|REST / WS| ORCH[LangGraph Orchestrator]
        style GW fill:#bbe3f0,stroke:#2b7f99
        style ORCH fill:#bbe3f0,stroke:#2b7f99

        %% adapters
        subgraph Adapters
            FHIR[FHIR Adapter] 
            VEC[pgvector Adapter]
            CLAUDE[Claude LLM Adapter]
        end
        style Adapters fill:#f0f9ff,stroke:#6985a1

        ORCH --> FHIR
        ORCH --> VEC
        ORCH --> CLAUDE
    end

    %% ─────────── Data plane ───────────
    subgraph Data["Stateful components"]
        PG[(Postgres + pgvector)]
        TS[(TimescaleDB)]
        BUS[(NATS / RabbitMQ)]
    end
    style Data fill:#fff8e6,stroke:#b48a34

    FHIR <-->|FHIR REST| EHR[(Hospital EHR<br>(Cambio / Cerner / Epic))]
    style EHR fill:#e9e9e9

    CLAUDE -->|HTTPS| ClaudeCloud[[Anthropic Claude<br>(EU region)]]

    ORCH -. traces .-> OTEL[OpenTelemetry Collector]
    BUS <-->|lab / bed events| EHR
    MET[Metrics Engine] -- writes --> TS
    BUS --> MET

    %% ─────────── Observability & CI/CD ───────────
    subgraph Ops["Ops & Visibility"]
        PROM[Prometheus] --> GRA[Grafana]
        GHA[GitHub Actions CI]
        ARGO[ArgoCD / Helm]
    end
    style Ops fill:#eef7e8,stroke:#5c8f5c

    OTEL --> PROM
    GHA -->|build & push| Backend
    ARGO -->|deploy| Backend

    %% ─────────── User flow arrows ───────────
    NJS -- OAuth / JWT --> GW
    GW -. fetch KPI .-> TS
    NJS ---- WebSocket KPI ----> GW
